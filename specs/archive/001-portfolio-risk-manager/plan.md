# Implementation Plan: Portfolio Risk Management System

**Branch**: `001-portfolio-risk-manager` | **Date**: February 12, 2026 | **Spec**: [spec.md](spec.md)

## Summary

Build a risk-first portfolio management system that aggregates positions from IBKR and Tastytrade, calculates Greeks, detects market regimes based on VIX and Polymarket data, and provides AI-assisted analysis following principles from Natenberg, Sebastian, Taleb, and Passarelli. The system will use Streamlit for visualization and expose tools for GitHub Copilot agent integration.

## Technical Context

**Language/Version**: Python 3.11+  
**Primary Dependencies**:

- Streamlit 1.30+ (dashboard)
- Pydantic 2.0+ (data models)
- Plotly 5.0+ (charts)
- aiohttp (async API calls)
- PyYAML (configuration)
- yfinance (market data)
- Existing: IBKR client, Tastytrade client

**Storage**:

- Configuration: YAML files (config/risk_matrix.yaml)
- Position snapshots: JSON files (existing ibkr_portfolio_client.py cache)
- No database required for MVP

**Testing**: pytest with fixtures for mock positions  
**Target Platform**: macOS/Linux development environment, web browser dashboard access  
**Project Type**: Single-repository Python application with web dashboard  
**Performance Goals**:

- Dashboard load < 3 seconds
- Greeks calculation < 1 second for 100 positions
- Risk checks < 500ms

**Constraints**:

- Greeks accuracy within 1% of broker values
- Must work with existing IBKR/Tastytrade integrations
- No modifications to broker authentication flow

**Scale/Scope**:

- Support 1-2 accounts per broker
- Handle up to 200 positions
- 7-10 main features (per user stories)

## Constitution Check

_Principles from trading literature:_

✅ **Natenberg**: IV vs HV comparison for edge detection (P7 user story)  
✅ **Sebastian**: Theta/Vega ratio monitoring (P3 user story)  
✅ **Taleb**: Gamma risk by expiration (P2 user story)  
✅ **Passarelli**: Synthetic adjustments (P4 AI recommendations)

## Project Structure

### Documentation (this feature)

```text
specs/001-portfolio-risk-manager/
├── plan.md              # This file
├── spec.md              # Feature specification with user stories
├── data-model.md        # UnifiedPosition, RegimeDetector classes
├── contracts/           # API contracts for adapters
│   └── broker_adapter.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
/Users/jsanchez/PycharmProjects/portfolioIBKR/
├── models/
│   └── unified_position.py          # Pydantic model for normalized positions
├── risk_engine/
│   ├── __init__.py
│   └── regime_detector.py           # Market regime detection logic
├── adapters/
│   ├── __init__.py
│   ├── base_adapter.py              # Abstract base class
│   ├── ibkr_adapter.py              # IBKR integration (uses existing client)
│   ├── tastytrade_adapter.py        # Tastytrade integration
│   └── polymarket_adapter.py        # Macro probabilities
├── agent_tools/
│   ├── __init__.py
│   ├── portfolio_tools.py           # Portfolio analysis functions
│   ├── market_data_tools.py         # VIX, Polymarket data fetchers
│   └── agent_config.py              # System prompt and tool schemas
├── dashboard/
│   └── app.py                       # Main Streamlit app (single-file for MVP, may extract components/ later if complexity grows)
├── config/
│   └── risk_matrix.yaml             # Regime-specific risk limits
├── tests/
│   ├── __init__.py
│   ├── conftest.py                  # pytest fixtures (mock adapters, positions)
│   ├── test_unified_position.py
│   ├── test_regime_detector.py
│   ├── test_ibkr_adapter.py
│   ├── test_tastytrade_adapter.py
│   ├── test_portfolio_tools.py
│   ├── test_market_data_tools.py
│   ├── test_iv_hv_calculator.py
│   ├── test_polymarket_adapter.py
│   ├── test_end_to_end.py
│   ├── fixtures/
│   │   ├── mock_ibkr_positions.json
│   │   ├── mock_tastytrade_positions.json
│   │   └── mock_vix_data.json
│   └── integration/
│       ├── test_tastytrade_integration.py  # Real API calls with credentials
│       └── test_yfinance_integration.py    # Real market data calls
├── ibkr_portfolio_client.py         # EXISTING - reuse as-is
├── tastytrade_options_fetcher.py    # EXISTING - reuse as-is
└── requirements.txt                 # Update with new dependencies
```

**Architectural Note**: Dashboard initially implemented as single-file `dashboard/app.py` for MVP simplicity (faster development, fewer imports). If complexity grows beyond ~500 lines, refactor into `dashboard/components/*.py` (regime_banner.py, gamma_heatmap.py, theta_vega_chart.py). Per Constitution Core Principle I: "MVP-first approach favors single-file simplicity over premature component extraction."

## Tech Stack Details

### Data Layer

**UnifiedPosition (Pydantic)**:

- Normalizes IBKR, Tastytrade, and future broker data
- Properties: symbol, instrument_type, quantity, Greeks, option details
- Computed property: `dte_bucket` for gamma risk grouping
- Validation: ensures required fields present, Greeks have default 0.0

**RegimeDetector**:

- Loads regime definitions from YAML config
- Input: VIX, term_structure (VIX3M/VIX), optional Polymarket prob
- Output: MarketRegime (name, description, limits)
- Logic: Crisis (VIX>35) > High (VIX>22 OR Recession>40%) > Low (VIX<15) > Neutral

### Adapter Pattern

All broker integrations implement `BrokerAdapter` abstract base:

- `fetch_positions(account_id) -> List[UnifiedPosition]`
- `fetch_greeks(positions) -> List[UnifiedPosition]`

**IBKRAdapter**:

- Wraps existing `ibkr_portfolio_client.py`
- Calls `client.get_positions(account_id)`
- Uses `client._extract_option_details()` for options
- Fetches Greeks via `client.get_tastytrade_option_greeks()` (existing cache)
- Calculates `spx_delta` via `client.calculate_spx_weighted_delta()`

**TastytradeAdapter**:

- Uses existing `tastytrade_options_fetcher.py`
- Fetches positions and Greeks in single call
- Maps to UnifiedPosition format

**PolymarketAdapter**:

- Async HTTP client to Polymarket CLOB API
- `get_recession_probability(year)` → searches markets, returns float
- Graceful fallback if API unavailable

### Risk Engine

**PortfolioTools**:

- `get_portfolio_summary()`: Aggregates Greeks, calculates Theta/Vega ratio
- `get_gamma_risk_by_dte()`: Groups by expiration buckets
- `check_risk_limits()`: Compares portfolio to regime limits
- `get_iv_analysis()`: Average IV across positions (HV comparison requires historical data)

**MarketDataTools**:

- `get_vix_data()`: yfinance for ^VIX and ^VIX3M
- `get_macro_indicators()`: Async call to Polymarket
- `get_spx_data()`: SPX price and 30-day realized vol

### Dashboard (Streamlit)

**Implementation**: Single-file `dashboard/app.py` for MVP (per Constitution Core Principle I: favor simplicity over premature componentization).

**Main Layout** (sections within app.py):

1. Sidebar: Account selector, refresh button
2. Regime banner: Color-coded regime status with VIX data
3. Summary cards: Delta, Theta, Vega, Gamma, Theta/Vega ratio
4. Risk compliance table: Limits vs current values
5. Gamma heatmap: Bar chart by DTE bucket (Plotly)
6. Theta/Vega scatter: Portfolio position vs target zones (Plotly)
7. AI assistant: Text input for agent queries

**Technical Features**:

- Cached initialization of clients and tools (st.cache_resource)
- Async position fetching with spinner (st.spinner)
- Color-coded regime banner (green/blue/orange/red per regime)
- Dynamic chart generation based on data (Plotly figures)
- Performance target: < 3 seconds render-to-interactivity (cached mode)

**Future Refactoring**: If app.py exceeds ~500 lines, extract `dashboard/components/` (regime_banner.py, gamma_heatmap.py, theta_vega_chart.py).

### AI Agent Integration

**System Prompt** (agent_config.py):

- Establishes role as quantitative trading assistant
- References Natenberg, Sebastian, Taleb, Passarelli principles
- Lists available tools and their purposes
- Defines constraints (always check regime, flag violations, etc.)

**Tool Schemas**:

- JSON schemas for function calling (OpenAI format)
- Tools: portfolio_summary, risk_limits, gamma_risk, vix_data, macro_indicators
- Integration point for GitHub Copilot via function calling

## Implementation Strategy

**MVP Approach**: User Story 1 (P1) first - portfolio risk summary dashboard

- Delivers immediate value: visibility into risk
- Foundation for all other features
- Can be demonstrated and provides ROI

**Incremental Delivery**: Each user story builds on previous

- P1: Basic dashboard + regime detection
- P2: Add gamma heatmap
- P3: Add Theta/Vega chart
- P4: AI agent integration
- P5-P7: Additional brokers and analysis

**Parallelization Opportunities**:

- Data model (UnifiedPosition) + Config (risk_matrix.yaml) can be created in parallel
- Adapters (IBKR, Tastytrade) can be built independently
- Dashboard components can be developed separately and composed

## Dependencies and Blocked Tasks

**Foundational** (must complete first):

- UnifiedPosition model
- RegimeDetector class
- risk_matrix.yaml configuration

**User Story Dependencies**:

- US1 (P1) → Blocks all others (foundational)
- US2 (P2) → Requires US1 complete
- US3 (P3) → Requires US1 complete (independent from US2)
- US4 (P4) → Requires US1-US3 (needs all tools available)
- US5 (P5) → Parallel with US1 (just adds adapter)
- US6 (P6) → Requires US1 (enhances regime detection)
- US7 (P7) → Requires US1 + historical data integration

## Configuration Files

### config/risk_matrix.yaml

```yaml
regimes:
  low_volatility:
    condition: "VIX < 15 and TermStructure > 1.10"
    description: "Complacency. Market grinds up. Cheap hedges available."
    limits:
      max_beta_delta: 600
      max_negative_vega: -500
      min_daily_theta: 100
      max_gamma: 50
      allowed_strategies:
        ["Long Calendars", "Debit Spreads", "Reverse Iron Condors"]

  neutral_volatility:
    condition: "15 <= VIX <= 22"
    description: "Standard operating environment."
    limits:
      max_beta_delta: 300
      max_negative_vega: -1200
      min_daily_theta: 300
      max_gamma: 35
      allowed_strategies: ["Iron Condors", "Strangles", "Credit Spreads"]

  high_volatility:
    condition: "VIX > 22 or Polymarket_Recession_Prob > 40%"
    description: "Fear. Elevated premiums. Fast moves."
    limits:
      max_beta_delta: 100
      max_negative_vega: -2500
      min_daily_theta: 600
      max_gamma: 20
      allowed_strategies:
        ["Ratio Backspreads", "Short Strangles (Managed)", "Jade Lizards"]

  crisis_mode:
    condition: "VIX > 35 or VVIX > 150"
    description: "Panic. Liquidity drying up."
    limits:
      max_beta_delta: 0
      max_negative_vega: 0
      min_daily_theta: 0
      max_gamma: 10
      allowed_strategies: ["Long Puts", "Cash", "Long Volatility"]
```

## External Dependencies

**Market Data**:

- VIX data via yfinance (^VIX, ^VIX3M)
- SPX data via yfinance (^GSPC)
- Polymarket API (public, no auth for MVP)

**Existing Integrations**:

- IBKR Client Portal API (already configured)
- Tastytrade SDK (already configured)

**New Python Packages**:

- streamlit
- plotly
- pydantic (if not installed)
- aiohttp
- pyyaml

## Risk Considerations

**Data Accuracy**: Greeks from Tastytrade cache may be stale

- Mitigation: Display timestamp of last update
- Future: Implement refresh mechanism

**API Rate Limits**: Polymarket API could rate limit

- Mitigation: Cache responses, graceful fallback

**Regime Transitions**: Portfolio could violate new limits on regime change

- Mitigation: AI agent alerts user to adjust

**Broker API Downtime**: IBKR gateway could be offline

- Mitigation: Use cached snapshot data, display warning

## Testing Strategy

**Unit Tests** (per Constitution Core Principle I: Test-First Development, 80% coverage target for business logic):

- UnifiedPosition validation (Pydantic models, dte_bucket property, Greek defaults)
- RegimeDetector logic with fixed VIX inputs (boundary conditions: VIX 35, 22, 15; term structure ratios)
- Adapter data transformation (IBKR → UnifiedPosition, Tastytrade → UnifiedPosition mapping)
- Portfolio aggregation math (sum Greeks, Theta/Vega ratio calculation with absolute values, SPX-weighted delta)
- IV/HV calculator with known price series (mock yfinance, test log returns)
- Polymarket adapter with mocked aiohttp responses

**Integration Tests** (per Constitution: Tastytrade programmatic auth supported, enable with `@pytest.mark.integration`):

- Tastytrade adapter with real API calls (use credentials from .env, verify position fetching if SDK supports)
- yfinance market data fetching (SPX, VIX, VIX3M with recorded fixtures for reproducibility)
- End-to-end portfolio load: mocked adapters → Greeks calculation → regime detection → risk checks (< 3s performance validation)

**Fixtures** (per Constitution: IBKR manual auth requires fixture-based mocking):

- `tests/fixtures/mock_ibkr_positions.json` — sample IBKR API response with 10-20 positions
- `tests/fixtures/mock_tastytrade_positions.json` — sample Tastytrade positions (if SDK supports)
- `tests/fixtures/mock_vix_data.json` — hardcoded VIX, VIX3M, VVIX values for regime testing
- `conftest.py` — pytest fixtures for IBKRClient mock, TastytradeAdapter mock, RegimeDetector instances

**Manual Testing** (per Constitution: dashboard testing remains manual due to Streamlit interactivity):

- Dashboard load time measurement (< 3 seconds cached mode, manual stopwatch)
- Chart rendering and interactivity (Plotly zoom, hover, regime banner color changes)
- AI agent responses (text input, GitHub Copilot integration)
- Error handling UX (offline broker API, stale data warnings)

**Test Execution**:

- `pytest tests/` — runs all unit tests (skip integration)
- `pytest tests/ -m integration` — runs integration tests (requires .env credentials)
- `pytest tests/test_end_to_end.py` — full workflow test with mocked adapters

## Success Metrics

**MVP Success** (P1 complete):

- Dashboard displays portfolio Greeks
- Regime correctly detected
- Risk violations flagged

**Full Feature Success** (P1-P4 complete):

- All charts render correctly
- AI agent provides useful recommendations
- System runs reliably for 1 week without crashes
