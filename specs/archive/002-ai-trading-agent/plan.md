# Implementation Plan: AI Trading Agent — Order Manager, Sentiment Sentry & Trade Explainer

**Branch**: `002-ai-trading-agent` | **Date**: 2026-02-17 | **Spec**: `specs/002-ai-trading-agent/spec.md`

## Summary

Build three independent, incrementally deliverable stages in the existing Python monorepo:

1. **Stage 1 — Order Manager**: `OrderRequest` Pydantic model + `OrderManager` that stages STK/FUT orders in TWS with `transmit=False`, persists them to a new `staged_orders` DB table via `database/db_manager.py`, and validates instrument types.
2. **Stage 2 — News Sentinel + Arb Hunter**: `NewsSentry` agent fetching from Alpaca/Finnhub every 15 minutes, calling an LLM to produce a [-1, +1] sentiment score stored in `market_intel`; `ArbHunter` scanning option chains for Box Spread and Put-Call Parity opportunities, writing to a `signals` table.
3. **Stage 3 — Copilot Trade Explainer**: `explain_performance` skill using the Copilot SDK that looks up `trade_journal` + `market_intel`, fetches current Greeks via the existing Tastytrade adapter, and produces a natural-language explanation comparing entry Greeks to current state.

## Technical Context

**Language/Version**: Python 3.13 (asyncio runtime; matches project `.venv` — `python@3.13.3`)
**Primary Dependencies**: `pydantic` (models), Client Portal REST (TWS staging via existing `ibkr_gateway_client.py`), existing `database/db_manager.py` (asyncpg/aiosqlite), `tastytrade` adapter for Greeks, `httpx` (transitive dep of `tastytrade`, pin explicitly), `apscheduler>=3.10` (15-min scheduling), `openai>=1.0` (Copilot/LLM calls; no first-party `copilot-sdk` PyPI package exists — use OpenAI-compatible endpoint or GitHub Models REST API)
**Storage**: Existing DB (SQLite locally, PostgreSQL for production) — extend existing schema
**Testing**: `pytest` unit + focused integration tests; tests explicitly requested in user description
**Target Platform**: macOS/Linux local runtime
**Project Type**: Single Python monorepo (same layout as `001-streaming-greeks-database`)
**Performance Goals**: `stage_order()` < 5s round-trip; Explainer response < 10s; NewsSentry tick-to-write ≤ 60s
**Constraints**: `transmit=False` enforced at all times for orders; no real-time Greek streaming for Explainer; fees for arb as configurable flat rate

## Project Structure

### Documentation (this feature)

```
specs/002-ai-trading-agent/
├── plan.md      ← this file
├── spec.md
├── checklists/
│   └── requirements.md
└── tasks.md     ← generated by /speckit.tasks
```

### Source Code additions

```
core/
└── order_manager.py          # US1 — OrderRequest model + stage_order()

agents/
├── __init__.py
├── news_sentry.py            # US2 — NewsSentry with LLM sentiment
└── arb_hunter.py             # US3 — Box Spread + Put-Call Parity scanner

skills/
├── __init__.py
└── explain_performance.py    # US4 — Copilot SDK "Explain Trade" skill

tests/
├── test_orders.py            # US1
├── test_news_sentry.py       # US2
├── test_arbitrage.py         # US3
└── test_explain_performance.py  # US4
```

**DB schema additions** (via `database/db_manager.py`):

- `staged_orders` — persists `StagedOrder` records (US1)
- `market_intel` — news + sentiment records (US2); also used by Explainer (US4)
- `signals` — arb opportunities (US3)

## Complexity Tracking

| Concern              | Decision                                                                                                                             |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| TWS connectivity     | Use existing `ibkr_gateway_client.py` pattern; `stage_order()` wraps Client Portal REST `POST /iserver/order` with `transmit: false` |
| LLM calls            | Copilot SDK `chat` completion; model configurable via env `LLM_MODEL` (default `gpt-4o-mini`)                                        |
| Scheduling           | `APScheduler` async scheduler; interval configurable via env `NEWS_INTERVAL_SECONDS` (default 900)                                   |
| Arb fees             | Configurable flat per-leg fee via `config/risk_matrix.yaml` extension                                                                |
| Greeks for Explainer | Poll via existing `IBKRClient.options_cache` at invocation time; no new stream required                                              |
